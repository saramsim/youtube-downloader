@app.route('/api/download', methods=['POST'])
def download_video():
    """Video indirme"""
    try:
        data = request.get_json()
        url = data.get('url')
        quality = data.get('quality', '720p')
        
        if not url:
            return jsonify({"error": "URL gerekli"}), 400
        
        video_id = extract_video_id(url)
        if not video_id:
            return jsonify({"error": "Geçersiz YouTube URL"}), 400
        
        # Basit format seçimi
        if quality == 'audio':
            format_selector = 'bestaudio[ext=m4a]/bestaudio'
            ext = 'mp3'
        elif quality == 'highest':
            format_selector = 'best[height<=1080]'
            ext = 'mp4'
        elif quality == '1080p':
            format_selector = 'best[height<=1080]'
            ext = 'mp4'
        elif quality == '720p':
            format_selector = 'best[height<=720]'
            ext = 'mp4'
        elif quality == '480p':
            format_selector = 'best[height<=480]'
            ext = 'mp4'
        else:
            format_selector = 'best[height<=360]'
            ext = 'mp4'
        
        # Dosya adını oluştur
        safe_title = re.sub(r'[^\w\-_\.]', '_', video_id)
        temp_filename = f"{safe_title}_{quality}_{int(time.time())}"
        output_path = os.path.join(TEMP_DIR, f'{temp_filename}.%(ext)s')
        
        # yt-dlp ayarları - basitleştirilmiş
        ydl_opts = {
            'format': format_selector,
            'outtmpl': output_path,
            'quiet': True,
            'no_warnings': True,
            'ignoreerrors': True,
        }
        
        # Ses için özel işlem
        if quality == 'audio':
            ydl_opts.update({
                'format': 'bestaudio',
                'postprocessors': [{
                    'key': 'FFmpegExtractAudio',
                    'preferredcodec': 'mp3',
                    'preferredquality': '192',
                }],
                'prefer_ffmpeg': True,
            })
        
        # Video indir
        try:
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                # Önce info al
                info = ydl.extract_info(url, download=False)
                title = info.get('title', 'video')
                
                # Güvenli dosya adı oluştur
                safe_title = re.sub(r'[^\w\-_\.]', '_', title[:50])
                final_filename = f"{safe_title}_{quality}.{ext}"
                final_output = os.path.join(TEMP_DIR, final_filename)
                
                # Yeni ayarlarla indir
                ydl_opts['outtmpl'] = final_output
                ydl.params.update(ydl_opts)
                ydl.download([url])
                
                # İndirilen dosyayı kontrol et
                if os.path.exists(final_output) and os.path.getsize(final_output) > 1000:
                    file_size = os.path.getsize(final_output)
                    
                    return jsonify({
                        "success": True,
                        "message": "Video başarıyla indirildi",
                        "download_url": f"/api/file/{final_filename}",
                        "file_size": file_size,
                        "filename": final_filename
                    })
                else:
                    # Alternatif dosya adlarını kontrol et
                    for file in os.listdir(TEMP_DIR):
                        if video_id in file and os.path.getsize(os.path.join(TEMP_DIR, file)) > 1000:
                            file_size = os.path.getsize(os.path.join(TEMP_DIR, file))
                            return jsonify({
                                "success": True,
                                "message": "Video başarıyla indirildi",
                                "download_url": f"/api/file/{file}",
                                "file_size": file_size,
                                "filename": file
                            })
                    
                    raise Exception("Dosya oluşturulamadı veya çok küçük")
                        
        except Exception as download_error:
            print(f"Download error: {download_error}")
            raise Exception(f"İndirme hatası: {str(download_error)}")
        
    except Exception as e:
        print(f"General error: {e}")
        return jsonify({"error": f"İndirme hatası: {str(e)}"}), 500
